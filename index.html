<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜…è¯»ç¬”è®° - é¦–é¡µ</title>
    <style>
        :root {
            --brand-color: #2d6a4f;
            --brand-light: rgba(240, 249, 244, 0.9);
            --brand-hover: rgba(220, 237, 226, 0.95);
            --text-main: #1a202c;
            --nav-bg: rgba(255, 255, 255, 0.85);
        }

        body { 
            margin: 0; font-family: "Georgia", "PingFang SC", serif; 
            background-image: url('sea.avif');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-main); padding-top: 70px;
        }

        /* --- å¯¼èˆªæ ä¼˜åŒ–ï¼šåŠ å…¥æœç´¢æ¡† --- */
        .top-nav {
            position: fixed; top: 0; width: 100%; height: 70px;
            background: var(--nav-bg); backdrop-filter: blur(12px);
            z-index: 1000; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 40px; box-sizing: border-box; box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .nav-left { font-weight: bold; color: var(--brand-color); font-size: 1.2rem; cursor: pointer; text-decoration: none; flex-shrink: 0; }
        
        /* æœç´¢æ¡†æ ·å¼ */
        .nav-search-container {
            flex-grow: 1;
            max-width: 500px;
            margin: 0 30px;
            position: relative;
            display: flex;
            align-items: center;
        }
        .nav-search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 25px;
            border: 1px solid rgba(45, 106, 79, 0.2);
            background: rgba(255, 255, 255, 0.7);
            outline: none;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        .nav-search-input:focus {
            background: #fff;
            border-color: var(--brand-color);
            box-shadow: 0 0 10px rgba(45, 106, 79, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 15px;
            color: var(--brand-color);
            opacity: 0.6;
        }

        .nav-right { display: flex; gap: 20px; flex-shrink: 0; }
        .nav-link { text-decoration: none; color: var(--text-main); font-size: 0.95rem; font-weight: 500; transition: 0.3s; }
        .nav-link:hover { color: var(--brand-color); }

        /* === æ–°å¢ï¼šéŸ³ä¹æŒ‰é’®æ ·å¼ === */
      .music-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-main);
    font-size: 0.95rem;
    font-weight: 500;
    padding: 4px 8px; /* ä¸æ–‡å­—é“¾æ¥çš„è§†è§‰é«˜åº¦/å†…è¾¹è·åŒ¹é… */
    border-radius: 6px;
    transition: color 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    line-height: 1.2;
}
.music-btn:hover {
    color: var(--brand-color);
}
.music-btn.playing {
    color: #e63946;
}

        /* éšè— audio å…ƒç´  */
        #bg-music {
            position: absolute;
            left: -9999px;
        }

        /* --- ç­›é€‰é¢æ¿ --- */
        .filter-panel {
            max-width: 1000px; margin: 40px auto 20px;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);
            padding: 20px 30px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .filter-group { display: flex; gap: 15px; align-items: center; }
        select, .btn-sort {
            padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd;
            background: white; cursor: pointer; font-family: inherit; transition: 0.2s;
        }
        .btn-sort:hover { background: var(--brand-light); border-color: var(--brand-color); }

        /* --- ç¬”è®°ç½‘æ ¼ --- */
        .note-grid {
            max-width: 1000px; margin: 0 auto 30px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px; padding: 0 20px;
        }

        .note-item {
            background: rgba(255, 255, 255, 0.92); border-radius: 15px;
            padding: 25px; transition: all 0.3s ease;
            text-decoration: none; color: inherit;
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.3);
            min-height: 200px;
        }
        .note-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            background: #fff;
            border-color: var(--brand-color);
        }
        .note-item h2 { margin: 0 0 10px 0; font-size: 1.3rem; color: var(--brand-color); line-height: 1.4; }
        .note-item .date { font-size: 0.85rem; color: #777; margin-bottom: 15px; }
        .note-item .excerpt { 
            font-size: 0.9rem; line-height: 1.6; color: #444; 
            margin-bottom: 20px; flex-grow: 1;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .mini-tag { font-size: 0.75rem; background: #eef5f1; padding: 2px 8px; border-radius: 4px; color: var(--brand-color); font-weight: bold; margin-right: 5px; margin-bottom: 5px; display: inline-block; }

        /* --- åˆ†é¡µæŒ‰é’® --- */
        .pagination {
            max-width: 1000px; margin: 0 auto 80px;
            display: flex; justify-content: center; align-items: center; gap: 20px;
        }
        .page-info { color: white; font-size: 0.9rem; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px; }
        .pagination button { background: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }

        @media (max-width: 768px) {
            .nav-search-container { display: none; } /* ç§»åŠ¨ç«¯æš‚æ—¶éšè—æœç´¢ä»¥èŠ‚çœç©ºé—´ */
            .filter-panel { flex-direction: column; gap: 15px; margin: 20px; }
        }
    </style>
</head>
<body>

<!-- èƒŒæ™¯éŸ³ä¹å…ƒç´ ï¼ˆé™éŸ³é¢„åŠ è½½ï¼‰ -->
<audio id="bg-music" preload="auto" loop>
    <source src="Over_Reprise.mp3" type="audio/mpeg">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘ã€‚
</audio>

<nav class="top-nav">
    <a href="index.html" class="nav-left">ğŸŒŠ çŒ«çŒ«å’©å’©é˜…è§ˆå®¤</a>
    

    <div class="nav-right">
        <a href="showitem.html?type=book" class="nav-link">ğŸ“š ä¹¦ç›®</a>
        <a href="showitem.html?type=paper" class="nav-link">ğŸ“ è®ºæ–‡</a>
        <!-- æ–°å¢ï¼šéŸ³ä¹æ’­æ”¾æŒ‰é’® -->
        <button class="music-btn" id="music-toggle" title="æ’­æ”¾/æš‚åœèƒŒæ™¯éŸ³ä¹">ğŸµ</button>
    </div>
</nav>

<div style="display: flex; justify-content: center; align-items: center; padding: 100px 20px 40px; width: 100%; box-sizing: border-box;">
    <div style="max-width: 800px; width: 100%; padding: 40px 60px; background: rgba(20, 20, 20, 0.4); backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3); text-align: center; color: #ffffff;">
        <h1 style="font-size: 3rem; margin-bottom: 25px; text-shadow: 0 2px 8px rgba(0,0,0,0.4); letter-spacing: 4px;">é˜…è¯»ç¬”è®°</h1>
        <p style="font-size: 1.15rem; line-height: 1.9; letter-spacing: 1px; text-align: justify; text-shadow: 0 1px 4px rgba(0,0,0,0.3); font-weight: 400; margin: 0;">
            â€œæˆ‘ä»¬å·²ç»æ— æ³•å‘å‰æ¨è¿›å¹¶æŠŠå¦å®šä»å®Œå…¨ç‰©åŒ–äº†çš„è¯­è¨€ä¸­æŒ¤å‡ºæ¥ï¼šäººä»¬å¹¶éæ²¡æœ‰å¬åˆ°æ‹’ç»å’ŒæŒ‡è´£ï¼Œç›¸åï¼Œä»–ä»¬æ—©å°±æ³¨æ„åˆ°äº†ï¼Œåªæ˜¯ä»–ä»¬å¬åˆ°ä¿¡æ¯ä¹‹åï¼Œå°±æŠŠå®ƒè½¬è¯‘æˆäº†ç¤¾ä¼šå­¦ã€å¿ƒç†å­¦å’Œç¾å­¦é—®é¢˜ï¼ŒæŠŠå…¶ä½™çš„å½“æˆäº†å‡è£…è‡ªæˆ‘æ‰¹åˆ¤çš„æ”¿æ²»å®£ä¼ ã€‚â€ <br>
            <span style="display: block; text-align: right; margin-top: 15px; opacity: 0.8;">â€”â€” é©¬å°”åº“å¡</span>
        </p>
    </div>
</div>

<section class="filter-panel">
    <div class="filter-group">
        <span>æ ‡ç­¾ç­›é€‰:</span>
        <select id="tagFilter" onchange="resetAndRender()">
            <option value="all">å…¨éƒ¨æ ‡ç­¾</option>
        </select>
    </div>
<div class="nav-search-container">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="globalSearch" class="nav-search-input" placeholder="æœç´¢æ ‡é¢˜ã€å†…å®¹ã€æ¥æºã€é™„æ³¨..." oninput="resetAndRender()">
    </div>
    <div id="statusLabel" style="font-size: 0.9rem; color: var(--brand-color); font-weight: bold;"></div>
    <div class="filter-group">
        <span>æ—¶é—´æ’åº:</span>
        <button class="btn-sort" onclick="sortNotes('desc')">å€’åº</button>
        <button class="btn-sort" onclick="sortNotes('asc')">æ­£åº</button>
    </div>
    
</section>

<div class="note-grid" id="noteGrid"></div>

<div class="pagination" id="paginationBar"></div>

<script src="notedata.js"></script>

<script>
    let currentSort = 'desc';
    let currentPage = 1;
    const pageSize = 12;

    // === æ–°å¢ï¼šéŸ³ä¹æ§åˆ¶é€»è¾‘ ===
    document.addEventListener('DOMContentLoaded', () => {
        const audio = document.getElementById('bg-music');
        const btn = document.getElementById('music-toggle');

        // é™éŸ³é¢„åŠ è½½ï¼Œç»•è¿‡ autoplay é™åˆ¶
        audio.muted = true;
        audio.load();

        btn.addEventListener('click', () => {
            if (audio.paused) {
                audio.muted = false;
                audio.play().then(() => {
                    btn.classList.add('playing');
                    btn.textContent = 'â¸ï¸';
                }).catch(err => {
                    alert('æ’­æ”¾å¤±è´¥ï¼šè¯·å…ˆä¸é¡µé¢è¿›è¡Œä¸€æ¬¡äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ä»»æ„ä½ç½®ï¼‰ï¼Œå†å°è¯•æ’­æ”¾éŸ³ä¹ã€‚');
                    console.warn('Autoplay blocked:', err);
                });
            } else {
                audio.pause();
                btn.classList.remove('playing');
                btn.textContent = 'ğŸµ';
            }
        });
    });

    function initFilters() {
        const selector = document.getElementById('tagFilter');
        const tags = new Set();
        Object.values(ALL_NOTES).forEach(note => {
            if (note.tag && Array.isArray(note.tag)) {
                note.tag.forEach(t => tags.add(t));
            }
        });
        const sortedTags = Array.from(tags).sort();
        sortedTags.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.innerText = "# " + t;
            selector.appendChild(opt);
        });
    }

    function resetAndRender() {
        currentPage = 1;
        renderNotes();
    }

    function sortNotes(order) {
        currentSort = order;
        currentPage = 1;
        renderNotes();
    }

    function changePage(step) {
        currentPage += step;
        renderNotes();
        window.scrollTo({ top: document.querySelector('.filter-panel').offsetTop - 100, behavior: 'smooth' });
    }

    function renderNotes() {
        const grid = document.getElementById('noteGrid');
        const pagiBar = document.getElementById('paginationBar');
        const tagFilter = document.getElementById('tagFilter').value;
        const searchQuery = document.getElementById('globalSearch').value.toLowerCase().trim();
        const statusLabel = document.getElementById('statusLabel');
        
        // 1. è½¬åŒ–ä¸ºæ•°ç»„
        let notesList = Object.keys(ALL_NOTES).map(id => ({ id: id, ...ALL_NOTES[id] }));

        // 2. æ‰§è¡Œæœç´¢è¿‡æ»¤ (æ·±åº¦åŒ¹é…æ‰€æœ‰æŒ‡å®šå­—æ®µ)
        if (searchQuery) {
            notesList = notesList.filter(n => {
                // åŒ¹é…æ ‡é¢˜
                const inTitle = (n.title || "").toLowerCase().includes(searchQuery);
                // åŒ¹é…æ¥æº
                const inSource = (n.source || "").toLowerCase().includes(searchQuery);
                // åŒ¹é…é™„æ³¨
                const inDetail = (n.detail || "").toLowerCase().includes(searchQuery);
                // åŒ¹é…å†…å®¹åŒºï¼ˆmaterial å’Œ commentsï¼‰
                const inContents = (n.contents || []).some(c => {
                    const materialMatch = (c.material || "").toLowerCase().includes(searchQuery);
                    const commentMatch = (c.comments || []).some(comm => comm.toLowerCase().includes(searchQuery));
                    return materialMatch || commentMatch;
                });

                return inTitle || inSource || inDetail || inContents;
            });
            statusLabel.innerText = `æ‰¾åˆ° ${notesList.length} æ¡åŒ¹é…ç»“æœ`;
        } else {
            statusLabel.innerText = "";
        }

        // 3. æ‰§è¡Œæ ‡ç­¾è¿‡æ»¤
        if (tagFilter !== 'all') {
            notesList = notesList.filter(n => n.tag && n.tag.includes(tagFilter));
        }

        // 4. æ‰§è¡Œæ’åº
        notesList.sort((a, b) => {
            const dateA = new Date(a.time || 0);
            const dateB = new Date(b.time || 0);
            return currentSort === 'desc' ? dateB - dateA : dateA - dateB;
        });

        // 5. åˆ†é¡µè®¡ç®—
        const totalItems = notesList.length;
        const totalPages = Math.ceil(totalItems / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pagedNotes = notesList.slice(start, end);

        // 6. æ¸²æŸ“ç½‘æ ¼
        if (pagedNotes.length === 0) {
            grid.innerHTML = `<div style="color:white; grid-column: 1/-1; text-align:center; padding: 100px; background: rgba(0,0,0,0.2); border-radius: 15px;">æœªèƒ½æ‰¾åˆ°ç›¸å…³ç¬”è®°</div>`;
            pagiBar.innerHTML = "";
            return;
        }

        grid.innerHTML = pagedNotes.map(n => {
            const firstContent = n.contents && n.contents[0] ? n.contents[0] : {};
            // é¢„è§ˆæ–‡å­—é€»è¾‘ï¼šä¼˜å…ˆæ˜¾ç¤º material é‡Œçš„æ–‡å­—
            const rawText = firstContent.material || (firstContent.comments ? firstContent.comments[0] : "") || "æš‚æ— é¢„è§ˆå†…å®¹";
            const excerpt = rawText.replace(/<[^>]+>/g, '').substring(0, 85);
            const displayTags = (n.tag || []).map(t => `<span class="mini-tag">#${t}</span>`).join('');

            return `
                <a href="note.html?id=${n.id}" class="note-item">
                    <h2>${n.title || 'æ— æ ‡é¢˜'}</h2>
                    <div class="date">ğŸ“… ${n.time || 'æœªçŸ¥æ—¥æœŸ'}</div>
                    <div class="excerpt">${excerpt}${rawText.length > 85 ? '...' : ''}</div>
                    <div class="note-tags">
                        ${displayTags}
                    </div>
                </a>
            `;
        }).join('');

        // 7. æ¸²æŸ“åˆ†é¡µ
        if (totalPages > 1) {
            pagiBar.innerHTML = `
                <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                <span class="page-info">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>
                <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
            `;
        } else {
            pagiBar.innerHTML = "";
        }
    }

    window.onload = () => {
        initFilters();
        renderNotes();
    };
</script>

</body>
</html>